# CircleCI configuration file

version: 2.1

executors:
  x86_64:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: large
  aarch64:
    docker:
      - image: cimg/openjdk:17.0.8
    resource_class: arm.large

jobs:
  build:
    parameters:
      platform:
        type: executor
    executor: << parameters.platform >>
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - checkout
      - run:
          name: Build native image
          command: ./mvnw -B -Pnative -Dspring-boot.build-image.imageName=ghcr.io/jotajoti/jid-server-spring:$CIRCLE_SHA1-$(uname -m) spring-boot:build-image
      - run:
          name: Authenticate ghcr
          command: echo $GITHUB_TOKEN | docker login ghcr.io -u jotajoti --password-stdin
      - run:
          name: Push image
          command: docker push ghcr.io/jotajoti/jid-server-spring:$CIRCLE_SHA1-$(uname -m)
  push-multi-arch-images:
    executor: x86_64
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Authenticate ghcr
          command: echo $GITHUB_TOKEN | docker login ghcr.io -u jotajoti --password-stdin
      - run:
          name: Build and push multi-arch image
          command: |docker buildx imagetools create --tag=ghcr.io/jotajoti/jid-server-spring:$CIRCLE_SHA1 ghcr.io/jotajoti/jid-server-spring:$CIRCLE_SHA1-aarch64 ghcr.io/jotajoti/jid-server-spring:$CIRCLE_SHA1-x86_64

workflows:
  build-and-push:
    jobs:
      - build:
          matrix:
            parameters:
              platform: [ x86_64, aarch64 ]
      - push-multi-arch-images:
          requires:
            - build
